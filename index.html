<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet.js ile Kesintisiz Yol Takibi</title>

    <!-- Leaflet CSS ve JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Leaflet.SimpleLocate -->
    <script src="https://unpkg.com/leaflet-simple-locate/dist/leaflet-simple-locate.min.js"></script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <script>
        let map = L.map('map').setView([37.426217, 31.851766], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap Katkıda Bulunanlar'
        }).addTo(map);

        // Örnek Polyline (kesintisiz bir rota)
        let routeCoordinates = [
            [37.426217, 31.851766],
            [37.426034, 31.851874],
            [37.425868, 31.851976],
            [37.425693, 31.852078],
            [37.425500, 31.852200],
            [37.425300, 31.852350],
            [37.425000, 31.852500]
        ];

        // Polyline rotasını çiz
        let routePolyline = L.polyline(routeCoordinates, { color: 'blue' }).addTo(map);

        // Leaflet.SimpleLocate başlat
        let locateControl = L.simpleLocate({
            position: 'topright',
            drawCircle: false,
            setView: true,
            keepCurrentZoomLevel: true,
            stopOnViewReset: false,
            showCompass: true,
            locateOptions: {
                enableHighAccuracy: true,
                watch: true
            }
        }).addTo(map);

        // Konum güncellendiğinde en yakın noktaya snapleme
        map.on('locationfound', function (event) {
            let userLatLng = [event.latlng.lat, event.latlng.lng];

            // Kullanıcının polyline üzerindeki en yakın noktasını bul
            let nearestPoint = findClosestPointOnPolyline(userLatLng, routePolyline);

            // Kullanıcıyı en yakın noktaya taşı
            locateControl.setMarkerPosition(nearestPoint);

            // Haritayı merkeze al
            map.setView(nearestPoint, 15);
        });

        // Verilen bir noktanın polyline üzerindeki en yakın noktasını hesaplar
        function findClosestPointOnPolyline(userLocation, polyline) {
            let latlngs = polyline.getLatLngs();
            let minDistance = Infinity;
            let closestPoint = null;

            for (let i = 0; i < latlngs.length - 1; i++) {
                let segmentStart = [latlngs[i].lat, latlngs[i].lng];
                let segmentEnd = [latlngs[i + 1].lat, latlngs[i + 1].lng];

                let projectedPoint = projectPointOnSegment(userLocation, segmentStart, segmentEnd);
                let distance = getDistance(userLocation, projectedPoint);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestPoint = projectedPoint;
                }
            }

            return closestPoint;
        }

        // İki nokta arasındaki mesafeyi hesaplayan fonksiyon
        function getDistance(point1, point2) {
            let latDiff = point1[0] - point2[0];
            let lngDiff = point1[1] - point2[1];
            return Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
        }

        // Bir noktanın bir çizgi segmenti üzerindeki en yakın noktasını hesaplar
        function projectPointOnSegment(point, segmentStart, segmentEnd) {
            let x0 = point[1], y0 = point[0];
            let x1 = segmentStart[1], y1 = segmentStart[0];
            let x2 = segmentEnd[1], y2 = segmentEnd[0];

            let dx = x2 - x1;
            let dy = y2 - y1;

            if (dx === 0 && dy === 0) {
                return segmentStart;
            }

            let t = ((x0 - x1) * dx + (y0 - y1) * dy) / (dx * dx + dy * dy);

            if (t < 0) return segmentStart;
            if (t > 1) return segmentEnd;

            return [y1 + t * dy, x1 + t * dx];
        }
    </script>

</body>

</html>
